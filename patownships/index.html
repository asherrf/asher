<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Municipality Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      height: 100%;
    }
    #map {
      height: 70vh;
      width: 100%;
    }
    #info {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 10px;
      border-bottom: 1px solid #ccc;
      z-index: 999;
    }
    #visited {
      padding: 10px;
      max-height: 30vh;
      overflow-y: auto;
    }
    .county-group {
      margin-bottom: 1em;
    }
    .county-group h3 {
      margin: 0 0 0.2em 0;
      font-size: 1.1em;
    }
    .municipality-name {
      display: inline-block;
      background: #eee;
      padding: 3px 8px;
      margin: 2px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="info">
    <strong>Current Municipality:</strong> <span id="current"></span>
  </div>
  <div id="map"></div>
  <div id="visited">
    <h2>Visited Municipalities</h2>
    <div id="visitedList"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax"></script>
  <script>
    const map = L.map('map').setView([40.05, -75.3], 10);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    const visited = new Set(JSON.parse(localStorage.getItem('visitedTownships') || '[]'));
    const visitedByCounty = {};

    function updateVisitedDisplay() {
      const container = document.getElementById('visitedList');
      container.innerHTML = '';

      // Group by county
      for (const county in visitedByCounty) {
        const towns = visitedByCounty[county];
        if (towns.length === 0) continue;

        const group = document.createElement('div');
        group.className = 'county-group';
        const heading = document.createElement('h3');
        heading.textContent = `${county} (${towns.length} visited)`;
        group.appendChild(heading);

        towns.forEach(name => {
          const div = document.createElement('div');
          div.className = 'municipality-name';
          div.textContent = name;
          group.appendChild(div);
        });

        container.appendChild(group);
      }
    }

    function displayName(props) {
      return props.NAME + ' Township, ' + props.COUNTY_NAME + ' County';
    }

    const geojsonLayer = new L.GeoJSON.AJAX('townships.geojson', {
      onEachFeature: function (feature, layer) {
        const props = feature.properties;
        const id = displayName(props);

        if (!visitedByCounty[props.COUNTY_NAME]) visitedByCounty[props.COUNTY_NAME] = [];

        layer.on('mouseover', function () {
          document.getElementById('current').textContent = id;
        });

        layer.on('click', function () {
          if (!visited.has(id)) {
            visited.add(id);
            visitedByCounty[props.COUNTY_NAME].push(props.NAME + ' Township');
          } else {
            visited.delete(id);
            visitedByCounty[props.COUNTY_NAME] = visitedByCounty[props.COUNTY_NAME].filter(n => n !== props.NAME + ' Township');
          }
          localStorage.setItem('visitedTownships', JSON.stringify([...visited]));
          updateVisitedDisplay();
          geojsonLayer.resetStyle(layer);
        });

        layer.setStyle({
          color: visited.has(id) ? 'blue' : 'gray',
          weight: 1,
          fillOpacity: visited.has(id) ? 0.6 : 0
        });
      }
    }).addTo(map);

    updateVisitedDisplay();
  </script>
</body>
</html>
